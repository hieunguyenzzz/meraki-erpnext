# PWA Implementation Plan - Meraki Manager

## Overview

Transform the React frontend (`refinefrontend/`) into a Progressive Web App (PWA) with push notifications, offline support, and mobile-optimized UI.

## Why PWA?

| Approach | Pros | Cons | Timeline |
|----------|------|------|----------|
| **PWA** | Single codebase, push notifications, offline access, installable | Limited native APIs | 2-3 weeks |
| React Native | Full native experience | New codebase, separate maintenance | 2-3 months |
| Capacitor | Native wrapper, same codebase | Build complexity, app store approval | 3-4 weeks |

**Decision**: PWA is ideal for this internal business tool - single codebase, push notifications supported, works offline at wedding venues.

## Architecture

```
refinefrontend/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ sw.js                    # Service worker (generated by vite-plugin-pwa)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ push-notifications.ts  # Push subscription management
â”‚   â”‚   â””â”€â”€ offline-sync.ts        # Background sync for offline actions
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â””â”€â”€ mobile-nav.tsx     # Bottom navigation for mobile
â”‚   â”‚   â””â”€â”€ pwa/
â”‚   â”‚       â”œâ”€â”€ install-prompt.tsx # "Add to Home Screen" prompt
â”‚   â”‚       â””â”€â”€ update-prompt.tsx  # "New version available" prompt
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ use-push-notifications.ts
â”œâ”€â”€ vite.config.ts               # PWA plugin configuration
â””â”€â”€ manifest.json                # Web app manifest (generated)
```

## Implementation Phases

### Phase 1: PWA Foundation (Week 1)

**Goal**: Make the app installable with basic offline caching.

#### 1.1 Install Dependencies

```bash
cd refinefrontend
npm install vite-plugin-pwa workbox-window
```

#### 1.2 Configure Vite PWA Plugin

```typescript
// vite.config.ts
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    // ... existing plugins
    VitePWA({
      registerType: 'prompt',
      includeAssets: ['favicon.ico', 'apple-touch-icon.png'],
      manifest: {
        name: 'Meraki Wedding Planner',
        short_name: 'Meraki',
        description: 'Wedding planning management system',
        theme_color: '#4f46e5',
        background_color: '#ffffff',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'maskable'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/app\.merakiwp\.com\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60 * 24 // 24 hours
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          }
        ]
      }
    })
  ]
})
```

#### 1.3 Create PWA Icons

Required icons (create in `public/`):
- `pwa-192x192.png` - Standard icon
- `pwa-512x512.png` - Large icon (also used as maskable)
- `apple-touch-icon.png` - iOS icon (180x180)
- `favicon.ico` - Browser tab icon

#### 1.4 Add Install Prompt Component

```typescript
// src/components/pwa/install-prompt.tsx
import { useRegisterSW } from 'virtual:pwa-register/react'

export function InstallPrompt() {
  const [showInstall, setShowInstall] = useState(false)
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null)

  useEffect(() => {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault()
      setDeferredPrompt(e)
      setShowInstall(true)
    })
  }, [])

  const handleInstall = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt()
      const { outcome } = await deferredPrompt.userChoice
      if (outcome === 'accepted') {
        setShowInstall(false)
      }
    }
  }

  if (!showInstall) return null

  return (
    <div className="fixed bottom-20 left-4 right-4 bg-primary text-white p-4 rounded-lg shadow-lg">
      <p className="font-medium">Install Meraki App</p>
      <p className="text-sm opacity-90">Add to home screen for quick access</p>
      <div className="mt-2 flex gap-2">
        <button onClick={handleInstall} className="bg-white text-primary px-4 py-2 rounded">
          Install
        </button>
        <button onClick={() => setShowInstall(false)} className="text-white/80">
          Later
        </button>
      </div>
    </div>
  )
}
```

#### 1.5 Add Update Prompt Component

```typescript
// src/components/pwa/update-prompt.tsx
import { useRegisterSW } from 'virtual:pwa-register/react'

export function UpdatePrompt() {
  const {
    needRefresh: [needRefresh, setNeedRefresh],
    updateServiceWorker
  } = useRegisterSW()

  if (!needRefresh) return null

  return (
    <div className="fixed top-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50">
      <p className="font-medium">New version available</p>
      <div className="mt-2 flex gap-2">
        <button
          onClick={() => updateServiceWorker(true)}
          className="bg-white text-blue-600 px-4 py-2 rounded"
        >
          Update
        </button>
        <button onClick={() => setNeedRefresh(false)} className="text-white/80">
          Later
        </button>
      </div>
    </div>
  )
}
```

### Phase 2: Push Notifications (Week 2)

**Goal**: Enable push notifications for new leads, communications, and wedding reminders.

#### 2.1 Backend: Push Notification Service

Create a new service in `webhook_v2/` or separate microservice:

```python
# push_notifications/service.py
import json
from pywebpush import webpush, WebPushException
from dataclasses import dataclass

@dataclass
class PushSubscription:
    endpoint: str
    keys: dict  # p256dh and auth keys

class PushNotificationService:
    def __init__(self, vapid_private_key: str, vapid_public_key: str, vapid_email: str):
        self.vapid_private_key = vapid_private_key
        self.vapid_public_key = vapid_public_key
        self.vapid_email = vapid_email

    def send_notification(self, subscription: PushSubscription, title: str, body: str, data: dict = None):
        payload = json.dumps({
            "title": title,
            "body": body,
            "data": data or {},
            "icon": "/pwa-192x192.png",
            "badge": "/badge-72x72.png"
        })

        try:
            webpush(
                subscription_info={
                    "endpoint": subscription.endpoint,
                    "keys": subscription.keys
                },
                data=payload,
                vapid_private_key=self.vapid_private_key,
                vapid_claims={
                    "sub": f"mailto:{self.vapid_email}"
                }
            )
            return True
        except WebPushException as e:
            print(f"Push failed: {e}")
            return False
```

#### 2.2 Backend: Subscription Storage

Store push subscriptions in ERPNext or PostgreSQL:

```python
# Option A: ERPNext Custom DocType "Push Subscription"
# Fields: user, endpoint, p256dh_key, auth_key, created_at

# Option B: PostgreSQL table
CREATE TABLE push_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    endpoint TEXT NOT NULL UNIQUE,
    p256dh_key TEXT NOT NULL,
    auth_key TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.3 Backend: API Endpoints

```python
# push_notifications/api.py
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel

router = APIRouter(prefix="/api/push")

class SubscriptionRequest(BaseModel):
    endpoint: str
    keys: dict  # { p256dh: str, auth: str }

@router.post("/subscribe")
async def subscribe(request: SubscriptionRequest, user_id: str = Depends(get_current_user)):
    # Store subscription
    save_subscription(user_id, request.endpoint, request.keys)
    return {"success": True}

@router.delete("/unsubscribe")
async def unsubscribe(endpoint: str, user_id: str = Depends(get_current_user)):
    # Remove subscription
    delete_subscription(user_id, endpoint)
    return {"success": True}

@router.get("/vapid-public-key")
async def get_vapid_key():
    return {"publicKey": VAPID_PUBLIC_KEY}
```

#### 2.4 Frontend: Push Subscription Hook

```typescript
// src/hooks/use-push-notifications.ts
import { useState, useEffect, useCallback } from 'react'

export function usePushNotifications() {
  const [isSupported, setIsSupported] = useState(false)
  const [isSubscribed, setIsSubscribed] = useState(false)
  const [subscription, setSubscription] = useState<PushSubscription | null>(null)

  useEffect(() => {
    setIsSupported('Notification' in window && 'serviceWorker' in navigator)
    checkSubscription()
  }, [])

  const checkSubscription = async () => {
    const registration = await navigator.serviceWorker.ready
    const sub = await registration.pushManager.getSubscription()
    setIsSubscribed(!!sub)
    setSubscription(sub)
  }

  const subscribe = useCallback(async () => {
    try {
      // Get VAPID public key from server
      const response = await fetch('/api/push/vapid-public-key')
      const { publicKey } = await response.json()

      const registration = await navigator.serviceWorker.ready
      const sub = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      })

      // Send subscription to server
      await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          endpoint: sub.endpoint,
          keys: {
            p256dh: arrayBufferToBase64(sub.getKey('p256dh')),
            auth: arrayBufferToBase64(sub.getKey('auth'))
          }
        })
      })

      setIsSubscribed(true)
      setSubscription(sub)
      return true
    } catch (error) {
      console.error('Push subscription failed:', error)
      return false
    }
  }, [])

  const unsubscribe = useCallback(async () => {
    if (subscription) {
      await subscription.unsubscribe()
      await fetch(`/api/push/unsubscribe?endpoint=${encodeURIComponent(subscription.endpoint)}`, {
        method: 'DELETE'
      })
      setIsSubscribed(false)
      setSubscription(null)
    }
  }, [subscription])

  return {
    isSupported,
    isSubscribed,
    subscribe,
    unsubscribe,
    requestPermission: () => Notification.requestPermission()
  }
}

// Utility functions
function urlBase64ToUint8Array(base64String: string) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4)
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')
  const rawData = window.atob(base64)
  const outputArray = new Uint8Array(rawData.length)
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i)
  }
  return outputArray
}

function arrayBufferToBase64(buffer: ArrayBuffer | null) {
  if (!buffer) return ''
  const bytes = new Uint8Array(buffer)
  return btoa(String.fromCharCode(...bytes))
}
```

#### 2.5 Service Worker Push Handler

```javascript
// Custom service worker additions (merged with Workbox-generated SW)
self.addEventListener('push', (event) => {
  const data = event.data?.json() || {}

  const options = {
    body: data.body || 'New notification',
    icon: data.icon || '/pwa-192x192.png',
    badge: data.badge || '/badge-72x72.png',
    data: data.data || {},
    actions: data.actions || [],
    tag: data.tag || 'default',
    renotify: true
  }

  event.waitUntil(
    self.registration.showNotification(data.title || 'Meraki', options)
  )
})

self.addEventListener('notificationclick', (event) => {
  event.notification.close()

  const data = event.notification.data
  let url = '/'

  // Navigate based on notification type
  if (data.type === 'new_lead') {
    url = `/leads/${data.lead_id}`
  } else if (data.type === 'new_communication') {
    url = `/communications/${data.communication_id}`
  } else if (data.type === 'wedding_reminder') {
    url = `/weddings/${data.wedding_id}`
  }

  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      // Focus existing window if open
      for (const client of clientList) {
        if (client.url.includes(self.location.origin) && 'focus' in client) {
          client.navigate(url)
          return client.focus()
        }
      }
      // Open new window if no existing window
      if (clients.openWindow) {
        return clients.openWindow(url)
      }
    })
  )
})
```

#### 2.6 Trigger Notifications

Integrate with email processor to send notifications:

```python
# webhook_v2/processors/backfill.py - Add notification trigger

async def process_email(email: Email):
    # ... existing lead creation logic ...

    if lead_created:
        # Send push notification to all subscribed users
        await push_service.notify_all_users(
            title="New Lead",
            body=f"New lead from {email.sender_name}",
            data={
                "type": "new_lead",
                "lead_id": lead_id
            }
        )
```

### Phase 3: Mobile UI - Dummy-Proof Design (Week 2-3)

**Goal**: Create a super simple, intuitive mobile experience that anyone can use without training.

#### Design Philosophy: "Wedding Venue Ready"

The mobile UI must work flawlessly in challenging conditions:
- **One-handed operation** - User might be holding flowers, clipboard, phone
- **Glanceable information** - Quick status checks between tasks
- **Zero learning curve** - Staff should use it immediately
- **Forgiving interactions** - Large touch targets, undo options, confirmations for destructive actions

#### 3.1 Visual Design System

**Aesthetic Direction**: Warm, elegant minimalism inspired by wedding stationery

```css
/* src/styles/mobile-theme.css */

/* Typography - Elegant but highly readable */
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Source+Sans+3:wght@400;500;600&display=swap');

:root {
  /* Warm, wedding-inspired palette */
  --color-cream: #FDF8F3;
  --color-blush: #F5E6E0;
  --color-rose: #C9A9A6;
  --color-sage: #A8B5A0;
  --color-charcoal: #3D3D3D;
  --color-gold: #C4A962;

  /* Status colors - soft but clear */
  --status-new: #7BA3C9;      /* Soft blue */
  --status-pending: #E8C47C;   /* Warm gold */
  --status-confirmed: #8FB573; /* Sage green */
  --status-urgent: #D4837A;    /* Muted coral */

  /* Typography */
  --font-display: 'Cormorant Garamond', serif;
  --font-body: 'Source Sans 3', sans-serif;

  /* Touch targets - minimum 48px for accessibility */
  --touch-target-min: 48px;
  --touch-target-comfortable: 56px;

  /* Spacing - generous for thumb reach */
  --spacing-card: 16px;
  --spacing-section: 24px;

  /* Safe areas */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Base mobile styles */
@media (max-width: 768px) {
  body {
    background: var(--color-cream);
    font-family: var(--font-body);
    -webkit-tap-highlight-color: transparent;
  }

  /* Prevent text selection on interactive elements */
  button, a, .card {
    -webkit-user-select: none;
    user-select: none;
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
}
```

#### 3.2 Bottom Navigation - Thumb-Friendly Zone

```typescript
// src/components/layout/mobile-nav.tsx
import { motion } from 'framer-motion'
import { Home, Heart, Calendar, Mail, User } from 'lucide-react'
import { Link, useLocation } from 'react-router-dom'

const navItems = [
  { icon: Home, label: 'Home', href: '/', color: 'var(--color-sage)' },
  { icon: Heart, label: 'Leads', href: '/leads', color: 'var(--color-rose)' },
  { icon: Calendar, label: 'Weddings', href: '/weddings', color: 'var(--color-gold)' },
  { icon: Mail, label: 'Messages', href: '/communications', color: 'var(--status-new)' },
  { icon: User, label: 'Me', href: '/settings', color: 'var(--color-charcoal)' }
]

export function MobileNav() {
  const location = useLocation()

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50 md:hidden"
         style={{ paddingBottom: 'var(--safe-bottom)' }}>
      {/* Frosted glass effect */}
      <div className="absolute inset-0 bg-white/80 backdrop-blur-xl border-t border-gray-100" />

      <div className="relative flex justify-around items-center h-16 px-2">
        {navItems.map((item) => {
          const isActive = location.pathname === item.href ||
                          (item.href !== '/' && location.pathname.startsWith(item.href))

          return (
            <Link
              key={item.href}
              to={item.href}
              className="flex flex-col items-center justify-center w-full py-2"
              style={{ minHeight: 'var(--touch-target-comfortable)' }}
            >
              <motion.div
                className="relative flex flex-col items-center"
                whileTap={{ scale: 0.9 }}
              >
                {/* Active indicator - subtle pill behind icon */}
                {isActive && (
                  <motion.div
                    layoutId="nav-indicator"
                    className="absolute -inset-2 rounded-2xl"
                    style={{ backgroundColor: `${item.color}20` }}
                    transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                  />
                )}

                <item.icon
                  className="relative h-6 w-6 transition-colors duration-200"
                  style={{ color: isActive ? item.color : '#9CA3AF' }}
                  strokeWidth={isActive ? 2.5 : 2}
                />

                <span
                  className="relative text-[11px] mt-1 font-medium transition-colors duration-200"
                  style={{ color: isActive ? item.color : '#9CA3AF' }}
                >
                  {item.label}
                </span>
              </motion.div>
            </Link>
          )
        })}
      </div>
    </nav>
  )
}
```

#### 3.3 Lead Cards - Scannable at a Glance

```typescript
// src/components/mobile/lead-card.tsx
import { motion } from 'framer-motion'
import { Phone, Mail, Calendar, ChevronRight } from 'lucide-react'

interface LeadCardProps {
  lead: {
    name: string
    lead_name: string
    email_id: string
    mobile_no: string
    status: string
    wedding_date?: string
    source: string
  }
  onClick: () => void
}

const statusConfig = {
  'New': { color: 'var(--status-new)', label: 'New', emoji: 'âœ¨' },
  'Open': { color: 'var(--status-pending)', label: 'Following up', emoji: 'ðŸ’¬' },
  'Replied': { color: 'var(--color-sage)', label: 'Replied', emoji: 'âœ“' },
  'Interested': { color: 'var(--status-confirmed)', label: 'Interested!', emoji: 'ðŸ’•' },
  'Converted': { color: 'var(--color-gold)', label: 'Booked', emoji: 'ðŸŽ‰' },
}

export function LeadCard({ lead, onClick }: LeadCardProps) {
  const status = statusConfig[lead.status] || statusConfig['New']

  return (
    <motion.div
      onClick={onClick}
      className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
      whileTap={{ scale: 0.98 }}
      style={{ minHeight: 'var(--touch-target-comfortable)' }}
    >
      {/* Status bar - color-coded top edge */}
      <div className="h-1" style={{ backgroundColor: status.color }} />

      <div className="p-4">
        {/* Header row */}
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1 min-w-0">
            {/* Name - prominent, truncated if needed */}
            <h3 className="font-semibold text-lg text-gray-900 truncate"
                style={{ fontFamily: 'var(--font-display)' }}>
              {lead.lead_name}
            </h3>

            {/* Source - subtle */}
            <p className="text-sm text-gray-400 mt-0.5">
              via {lead.source}
            </p>
          </div>

          {/* Status badge */}
          <div
            className="flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
            style={{
              backgroundColor: `${status.color}15`,
              color: status.color
            }}
          >
            <span>{status.emoji}</span>
            <span>{status.label}</span>
          </div>
        </div>

        {/* Quick info row - large touch targets */}
        <div className="flex gap-2 mt-3">
          {lead.mobile_no && (
            <a
              href={`tel:${lead.mobile_no}`}
              onClick={(e) => e.stopPropagation()}
              className="flex items-center gap-2 px-3 py-2 rounded-xl bg-green-50 text-green-700"
              style={{ minHeight: 'var(--touch-target-min)' }}
            >
              <Phone className="h-4 w-4" />
              <span className="text-sm font-medium">Call</span>
            </a>
          )}

          {lead.email_id && (
            <a
              href={`mailto:${lead.email_id}`}
              onClick={(e) => e.stopPropagation()}
              className="flex items-center gap-2 px-3 py-2 rounded-xl bg-blue-50 text-blue-700"
              style={{ minHeight: 'var(--touch-target-min)' }}
            >
              <Mail className="h-4 w-4" />
              <span className="text-sm font-medium">Email</span>
            </a>
          )}

          {lead.wedding_date && (
            <div className="flex items-center gap-2 px-3 py-2 rounded-xl bg-amber-50 text-amber-700">
              <Calendar className="h-4 w-4" />
              <span className="text-sm font-medium">
                {new Date(lead.wedding_date).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric'
                })}
              </span>
            </div>
          )}
        </div>

        {/* Tap hint */}
        <div className="flex items-center justify-end mt-3 text-gray-300">
          <span className="text-xs">Tap for details</span>
          <ChevronRight className="h-4 w-4" />
        </div>
      </div>
    </motion.div>
  )
}
```

#### 3.4 Quick Actions - FAB with Context Menu

```typescript
// src/components/mobile/quick-actions.tsx
import { motion, AnimatePresence } from 'framer-motion'
import { Plus, X, Phone, UserPlus, Calendar, MessageCircle } from 'lucide-react'
import { useState } from 'react'

const actions = [
  { icon: UserPlus, label: 'New Lead', color: 'var(--color-rose)', href: '/leads/create' },
  { icon: Phone, label: 'Log Call', color: 'var(--color-sage)', href: '/calls/create' },
  { icon: Calendar, label: 'Schedule', color: 'var(--color-gold)', href: '/calendar' },
  { icon: MessageCircle, label: 'Quick Note', color: 'var(--status-new)', href: '/notes/create' },
]

export function QuickActionFab() {
  const [isOpen, setIsOpen] = useState(false)

  return (
    <>
      {/* Backdrop */}
      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 md:hidden"
            onClick={() => setIsOpen(false)}
          />
        )}
      </AnimatePresence>

      {/* FAB and menu */}
      <div className="fixed right-4 z-50 md:hidden"
           style={{ bottom: 'calc(80px + var(--safe-bottom))' }}>

        {/* Action buttons */}
        <AnimatePresence>
          {isOpen && (
            <motion.div className="absolute bottom-16 right-0 flex flex-col gap-3">
              {actions.map((action, index) => (
                <motion.a
                  key={action.label}
                  href={action.href}
                  initial={{ opacity: 0, scale: 0.5, y: 20 }}
                  animate={{ opacity: 1, scale: 1, y: 0 }}
                  exit={{ opacity: 0, scale: 0.5, y: 20 }}
                  transition={{ delay: index * 0.05 }}
                  className="flex items-center gap-3"
                >
                  {/* Label */}
                  <span className="px-3 py-2 bg-white rounded-lg shadow-md text-sm font-medium text-gray-700 whitespace-nowrap">
                    {action.label}
                  </span>

                  {/* Icon button */}
                  <div
                    className="w-12 h-12 rounded-full shadow-lg flex items-center justify-center"
                    style={{ backgroundColor: action.color }}
                  >
                    <action.icon className="h-5 w-5 text-white" />
                  </div>
                </motion.a>
              ))}
            </motion.div>
          )}
        </AnimatePresence>

        {/* Main FAB */}
        <motion.button
          onClick={() => setIsOpen(!isOpen)}
          className="w-14 h-14 rounded-full shadow-xl flex items-center justify-center"
          style={{
            backgroundColor: isOpen ? 'var(--color-charcoal)' : 'var(--color-rose)',
            minHeight: 'var(--touch-target-comfortable)',
            minWidth: 'var(--touch-target-comfortable)'
          }}
          whileTap={{ scale: 0.9 }}
          animate={{ rotate: isOpen ? 45 : 0 }}
        >
          {isOpen ? (
            <X className="h-6 w-6 text-white" />
          ) : (
            <Plus className="h-6 w-6 text-white" />
          )}
        </motion.button>
      </div>
    </>
  )
}
```

#### 3.5 Empty States - Friendly & Helpful

```typescript
// src/components/mobile/empty-state.tsx
interface EmptyStateProps {
  icon: React.ReactNode
  title: string
  description: string
  actionLabel?: string
  onAction?: () => void
}

export function EmptyState({ icon, title, description, actionLabel, onAction }: EmptyStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-16 px-8 text-center">
      {/* Decorative icon with soft background */}
      <div className="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-6">
        <div className="text-gray-400">
          {icon}
        </div>
      </div>

      <h3 className="text-xl font-semibold text-gray-900 mb-2"
          style={{ fontFamily: 'var(--font-display)' }}>
        {title}
      </h3>

      <p className="text-gray-500 mb-6 max-w-xs">
        {description}
      </p>

      {actionLabel && onAction && (
        <button
          onClick={onAction}
          className="px-6 py-3 rounded-full font-medium text-white"
          style={{
            backgroundColor: 'var(--color-rose)',
            minHeight: 'var(--touch-target-comfortable)'
          }}
        >
          {actionLabel}
        </button>
      )}
    </div>
  )
}

// Usage examples:
// <EmptyState
//   icon={<Heart className="h-8 w-8" />}
//   title="No leads yet"
//   description="When new inquiries come in, they'll appear here"
//   actionLabel="Add your first lead"
//   onAction={() => navigate('/leads/create')}
// />
```

#### 3.6 Pull-to-Refresh with Visual Feedback

```typescript
// src/components/mobile/pull-to-refresh.tsx
import { motion, useMotionValue, useTransform } from 'framer-motion'
import { RefreshCw } from 'lucide-react'

interface PullToRefreshProps {
  onRefresh: () => Promise<void>
  children: React.ReactNode
}

export function PullToRefresh({ onRefresh, children }: PullToRefreshProps) {
  const [isRefreshing, setIsRefreshing] = useState(false)
  const y = useMotionValue(0)
  const opacity = useTransform(y, [0, 60], [0, 1])
  const rotate = useTransform(y, [0, 60], [0, 180])
  const scale = useTransform(y, [0, 60], [0.5, 1])

  return (
    <div className="relative overflow-hidden">
      {/* Pull indicator */}
      <motion.div
        className="absolute top-0 left-0 right-0 flex justify-center py-4 z-10"
        style={{ opacity }}
      >
        <motion.div
          className="w-10 h-10 rounded-full bg-white shadow-lg flex items-center justify-center"
          style={{ scale, rotate }}
        >
          <RefreshCw
            className={`h-5 w-5 text-gray-600 ${isRefreshing ? 'animate-spin' : ''}`}
          />
        </motion.div>
      </motion.div>

      {/* Content */}
      <motion.div
        drag="y"
        dragConstraints={{ top: 0, bottom: 0 }}
        dragElastic={{ top: 0.5, bottom: 0 }}
        style={{ y }}
        onDragEnd={async (_, info) => {
          if (info.offset.y > 80 && !isRefreshing) {
            setIsRefreshing(true)
            await onRefresh()
            setIsRefreshing(false)
          }
        }}
      >
        {children}
      </motion.div>
    </div>
  )
}
```

#### 3.7 Confirmation Dialogs - Prevent Mistakes

```typescript
// src/components/mobile/confirm-dialog.tsx
import { motion, AnimatePresence } from 'framer-motion'
import { AlertTriangle } from 'lucide-react'

interface ConfirmDialogProps {
  isOpen: boolean
  title: string
  message: string
  confirmLabel: string
  cancelLabel?: string
  variant?: 'danger' | 'warning' | 'info'
  onConfirm: () => void
  onCancel: () => void
}

export function ConfirmDialog({
  isOpen,
  title,
  message,
  confirmLabel,
  cancelLabel = 'Cancel',
  variant = 'warning',
  onConfirm,
  onCancel
}: ConfirmDialogProps) {
  const variantStyles = {
    danger: { bg: 'var(--status-urgent)', icon: AlertTriangle },
    warning: { bg: 'var(--status-pending)', icon: AlertTriangle },
    info: { bg: 'var(--status-new)', icon: AlertTriangle },
  }

  const style = variantStyles[variant]

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 z-50"
            onClick={onCancel}
          />

          {/* Dialog */}
          <motion.div
            initial={{ opacity: 0, scale: 0.9, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.9, y: 20 }}
            className="fixed left-4 right-4 bottom-8 bg-white rounded-2xl shadow-2xl z-50 overflow-hidden"
            style={{ paddingBottom: 'var(--safe-bottom)' }}
          >
            <div className="p-6">
              {/* Icon */}
              <div
                className="w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto"
                style={{ backgroundColor: `${style.bg}20` }}
              >
                <style.icon className="h-6 w-6" style={{ color: style.bg }} />
              </div>

              {/* Content */}
              <h3 className="text-xl font-semibold text-center text-gray-900 mb-2"
                  style={{ fontFamily: 'var(--font-display)' }}>
                {title}
              </h3>
              <p className="text-gray-500 text-center mb-6">
                {message}
              </p>

              {/* Actions - stacked for easy thumb reach */}
              <div className="flex flex-col gap-3">
                <button
                  onClick={onConfirm}
                  className="w-full py-4 rounded-xl font-semibold text-white"
                  style={{
                    backgroundColor: style.bg,
                    minHeight: 'var(--touch-target-comfortable)'
                  }}
                >
                  {confirmLabel}
                </button>

                <button
                  onClick={onCancel}
                  className="w-full py-4 rounded-xl font-semibold text-gray-600 bg-gray-100"
                  style={{ minHeight: 'var(--touch-target-comfortable)' }}
                >
                  {cancelLabel}
                </button>
              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}
```

#### 3.8 Loading States - Keep Users Informed

```typescript
// src/components/mobile/loading-skeleton.tsx
export function LeadCardSkeleton() {
  return (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden animate-pulse">
      <div className="h-1 bg-gray-200" />
      <div className="p-4">
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1">
            <div className="h-6 bg-gray-200 rounded w-3/4 mb-2" />
            <div className="h-4 bg-gray-100 rounded w-1/3" />
          </div>
          <div className="h-8 bg-gray-200 rounded-full w-24" />
        </div>
        <div className="flex gap-2 mt-3">
          <div className="h-10 bg-gray-100 rounded-xl w-20" />
          <div className="h-10 bg-gray-100 rounded-xl w-20" />
        </div>
      </div>
    </div>
  )
}

export function LeadListSkeleton({ count = 5 }: { count?: number }) {
  return (
    <div className="space-y-3">
      {Array.from({ length: count }).map((_, i) => (
        <LeadCardSkeleton key={i} />
      ))}
    </div>
  )
}
```

#### 3.9 Offline Indicator - Always Visible

```typescript
// src/components/mobile/offline-banner.tsx
import { motion, AnimatePresence } from 'framer-motion'
import { WifiOff, RefreshCw } from 'lucide-react'
import { useOnlineStatus } from '@/hooks/use-online-status'

export function OfflineBanner() {
  const isOnline = useOnlineStatus()
  const [pendingCount, setPendingCount] = useState(0)

  return (
    <AnimatePresence>
      {!isOnline && (
        <motion.div
          initial={{ height: 0, opacity: 0 }}
          animate={{ height: 'auto', opacity: 1 }}
          exit={{ height: 0, opacity: 0 }}
          className="fixed top-0 left-0 right-0 z-50 overflow-hidden"
          style={{ paddingTop: 'var(--safe-top)' }}
        >
          <div className="bg-amber-500 text-white px-4 py-3 flex items-center justify-center gap-2">
            <WifiOff className="h-4 w-4" />
            <span className="text-sm font-medium">
              You're offline
              {pendingCount > 0 && ` â€¢ ${pendingCount} changes pending`}
            </span>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  )
}
```

#### 3.10 Safe Area Insets (iOS Notch)

```css
/* src/index.css */
:root {
  --sat: env(safe-area-inset-top);
  --sar: env(safe-area-inset-right);
  --sab: env(safe-area-inset-bottom);
  --sal: env(safe-area-inset-left);
}

.pb-safe {
  padding-bottom: max(1rem, var(--sab));
}

.pt-safe {
  padding-top: max(1rem, var(--sat));
}
```

### Phase 4: Offline Support (Week 3)

**Goal**: Allow viewing and basic editing while offline.

#### 4.1 Offline Data Caching Strategy

```typescript
// src/lib/offline-cache.ts
import { openDB, IDBPDatabase } from 'idb'

const DB_NAME = 'meraki-offline'
const STORES = {
  leads: 'leads',
  weddings: 'weddings',
  communications: 'communications',
  pendingActions: 'pending-actions'
}

let db: IDBPDatabase

export async function initOfflineDB() {
  db = await openDB(DB_NAME, 1, {
    upgrade(db) {
      db.createObjectStore(STORES.leads, { keyPath: 'name' })
      db.createObjectStore(STORES.weddings, { keyPath: 'name' })
      db.createObjectStore(STORES.communications, { keyPath: 'name' })
      db.createObjectStore(STORES.pendingActions, { keyPath: 'id', autoIncrement: true })
    }
  })
}

export async function cacheData(store: string, data: any[]) {
  const tx = db.transaction(store, 'readwrite')
  await Promise.all(data.map(item => tx.store.put(item)))
  await tx.done
}

export async function getCachedData(store: string) {
  return db.getAll(store)
}

export async function addPendingAction(action: { type: string, payload: any }) {
  return db.add(STORES.pendingActions, {
    ...action,
    timestamp: Date.now()
  })
}

export async function syncPendingActions() {
  const actions = await db.getAll(STORES.pendingActions)
  for (const action of actions) {
    try {
      await executeAction(action)
      await db.delete(STORES.pendingActions, action.id)
    } catch (error) {
      console.error('Failed to sync action:', action, error)
    }
  }
}
```

#### 4.2 Background Sync

```javascript
// Service worker background sync
self.addEventListener('sync', (event) => {
  if (event.tag === 'sync-pending-actions') {
    event.waitUntil(syncPendingActions())
  }
})

async function syncPendingActions() {
  const db = await openDB('meraki-offline', 1)
  const actions = await db.getAll('pending-actions')

  for (const action of actions) {
    try {
      const response = await fetch(action.url, {
        method: action.method,
        headers: action.headers,
        body: JSON.stringify(action.payload)
      })

      if (response.ok) {
        await db.delete('pending-actions', action.id)
      }
    } catch (error) {
      console.error('Sync failed for action:', action.id)
    }
  }
}
```

## Environment Variables

Add to Dokploy environment:

```env
# VAPID Keys for Push Notifications (generate once and keep secret)
VAPID_PUBLIC_KEY=<generated-public-key>
VAPID_PRIVATE_KEY=<generated-private-key>
VAPID_EMAIL=admin@merakiweddingplanner.com
```

Generate VAPID keys:
```bash
npx web-push generate-vapid-keys
```

## Notification Types

| Event | Title | Body | Navigate To |
|-------|-------|------|-------------|
| New Lead | "New Lead" | "New lead from {sender_name}" | `/leads/{lead_id}` |
| New Communication | "New Message" | "{subject}" | `/communications/{id}` |
| Wedding Reminder | "Wedding Tomorrow" | "{customer_name} wedding at {venue}" | `/weddings/{id}` |
| AI Response Ready | "Response Ready" | "AI suggestion for {lead_name}" | `/leads/{lead_id}` |

## Testing Checklist

### PWA Installation
- [ ] Install prompt appears on mobile browsers
- [ ] App installs to home screen
- [ ] App opens in standalone mode (no browser UI)
- [ ] App icon appears correctly
- [ ] Splash screen shows during load

### Push Notifications
- [ ] Permission prompt appears
- [ ] Subscription stored in database
- [ ] Notification appears when new lead created
- [ ] Clicking notification opens correct page
- [ ] Notifications work when app is closed

### Offline Support
- [ ] App loads when offline (shows cached data)
- [ ] Offline indicator appears
- [ ] Actions queued while offline
- [ ] Actions sync when back online

### Mobile UI
- [ ] Bottom navigation visible on mobile
- [ ] Tables switch to card view on mobile
- [ ] Pull-to-refresh works
- [ ] Safe area insets respected (iPhone notch)

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `refinefrontend/vite.config.ts` | Modify | Add VitePWA plugin |
| `refinefrontend/public/pwa-*.png` | Create | PWA icons |
| `refinefrontend/src/components/pwa/install-prompt.tsx` | Create | Install prompt |
| `refinefrontend/src/components/pwa/update-prompt.tsx` | Create | Update prompt |
| `refinefrontend/src/components/layout/mobile-nav.tsx` | Create | Bottom navigation |
| `refinefrontend/src/hooks/use-push-notifications.ts` | Create | Push subscription hook |
| `refinefrontend/src/lib/offline-cache.ts` | Create | IndexedDB caching |
| `push-service/` | Create | New microservice for push notifications |

## Timeline

| Week | Phase | Deliverables |
|------|-------|--------------|
| Week 1 | PWA Foundation | Installable app, basic offline caching, install/update prompts |
| Week 2 | Push Notifications | Backend service, subscription management, notification triggers |
| Week 2-3 | Mobile UI | Bottom nav, card views, pull-to-refresh |
| Week 3 | Offline Support | IndexedDB caching, background sync, offline indicators |

## Dependencies

**Frontend:**
- `vite-plugin-pwa` - PWA generation
- `workbox-window` - Service worker management
- `idb` - IndexedDB wrapper

**Backend (Push Service):**
- `pywebpush` - Web Push protocol
- `fastapi` - API framework (or integrate into existing service)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Safari limitations | Push not fully supported on iOS <16.4 | Show banner to update iOS |
| Service worker caching issues | Stale data | Implement versioning, cache busting |
| IndexedDB storage limits | Data loss on mobile | Prioritize critical data, cleanup old cache |
| Background sync not triggered | Pending actions stuck | Manual sync button, periodic retry |

## Success Metrics

1. **Installation Rate**: >50% of mobile users install PWA
2. **Push Opt-in Rate**: >70% of users enable notifications
3. **Offline Usage**: App usable at venues with poor connectivity
4. **Response Time**: <3s initial load, <1s subsequent loads

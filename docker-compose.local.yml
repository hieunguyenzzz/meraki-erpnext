services:
  backend:
    networks:
      default:
        aliases:
          - meraki-backend

  websocket:
    networks:
      default:
        aliases:
          - meraki-websocket

  frontend:
    environment:
      BACKEND: meraki-backend:8000
      SOCKETIO: meraki-websocket:9000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meraki-frontend.rule=Host(`merakierp.loc`)"
      - "traefik.http.routers.meraki-frontend.entrypoints=web"
      - "traefik.http.services.meraki-frontend.loadbalancer.server.port=8080"
      - "traefik.docker.network=local-dev"
    networks:
      default:
        aliases:
          - erpnext-frontend
      traefik:

  react-frontend:
    build:
      context: ./refinefrontend
      dockerfile: Dockerfile
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meraki-react.rule=Host(`frontend.merakierp.loc`)"
      - "traefik.http.routers.meraki-react.entrypoints=web"
      - "traefik.http.services.meraki-react.loadbalancer.server.port=8090"
      - "traefik.docker.network=local-dev"
    networks:
      - default
      - traefik
    depends_on:
      - frontend

  # Email Processing v2
  email-storage:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "5434:5432"
    environment:
      POSTGRES_DB: email_processing
      POSTGRES_USER: email_processor
      POSTGRES_PASSWORD: ${EMAIL_STORAGE_PASSWORD:-email_processor_secret}
    volumes:
      - email-storage-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U email_processor -d email_processing"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Wedding Planner Agent - AI-powered response suggestions
  wedding-planner-agent:
    build:
      context: ./wedding-planner-agent
      dockerfile: Dockerfile
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meraki-planner.rule=Host(`planner.merakierp.loc`)"
      - "traefik.http.routers.meraki-planner.entrypoints=web"
      - "traefik.http.services.meraki-planner.loadbalancer.server.port=8003"
      - "traefik.docker.network=local-dev"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
      - ERPNEXT_URL=http://meraki-backend:8000
      - ERPNEXT_API_KEY=${ERPNEXT_API_KEY}
      - ERPNEXT_API_SECRET=${ERPNEXT_API_SECRET}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    networks:
      - default
      - traefik
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Classifier Agent - Standalone AI classification service
  classifier-agent:
    build:
      context: ./classifier-agent
      dockerfile: Dockerfile
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meraki-classifier.rule=Host(`classifier.merakierp.loc`)"
      - "traefik.http.routers.meraki-classifier.entrypoints=web"
      - "traefik.http.services.meraki-classifier.loadbalancer.server.port=8002"
      - "traefik.docker.network=local-dev"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    networks:
      - default
      - traefik
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  email-processor-v2:
    build:
      context: ./webhook_v2
      dockerfile: Dockerfile
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meraki-email-v2.rule=Host(`email-v2.merakierp.loc`)"
      - "traefik.http.routers.meraki-email-v2.entrypoints=web"
      - "traefik.http.services.meraki-email-v2.loadbalancer.server.port=8001"
      - "traefik.docker.network=local-dev"
    environment:
      # IMAP
      - ZOHO_HOST=${ZOHO_IMAP_HOST:-imappro.zoho.com}
      - ZOHO_EMAIL=${ZOHO_EMAIL:-info@merakiweddingplanner.com}
      - ZOHO_PASSWORD=${ZOHO_PASSWORD}
      # Email Storage DB
      - EMAIL_STORAGE_HOST=email-storage
      - EMAIL_STORAGE_PORT=5432
      - EMAIL_STORAGE_DB=email_processing
      - EMAIL_STORAGE_USER=email_processor
      - EMAIL_STORAGE_PASSWORD=${EMAIL_STORAGE_PASSWORD:-email_processor_secret}
      # ERPNext - connect directly to backend to avoid nginx intermittent 401 issues
      - ERPNEXT_URL=http://meraki-backend:8000
      - ERPNEXT_API_KEY=${ERPNEXT_API_KEY}
      - ERPNEXT_API_SECRET=${ERPNEXT_API_SECRET}
      # Classifier service
      - CLASSIFIER_SERVICE_URL=http://classifier-agent:8002
      - USE_REMOTE_CLASSIFIER=${USE_REMOTE_CLASSIFIER:-true}
      # Gemini (fallback if remote classifier disabled)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
      # MinIO
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio-api.hieunguyen.dev}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=${MINIO_BUCKET:-merakiweddingplanner}
    depends_on:
      email-storage:
        condition: service_healthy
      frontend:
        condition: service_started
      classifier-agent:
        condition: service_healthy
    networks:
      - default
      - traefik
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  email-storage-data:

networks:
  traefik:
    name: local-dev
    external: true
